services:
  booklore:
    image: booklore/booklore:latest
    container_name: booklore
    environment:
      - PUID=1000
      - PGID=1001
      - TZ={{ docker.tz }}
      - DATABASE_URL=jdbc:mariadb://mariadb:3306/booklore # Only modify this if you're familiar with JDBC and your database setup
      - DATABASE_USERNAME={{ host.booklore.db_user }} # Must match MYSQL_USER defined in the mariadb container
      - DATABASE_PASSWORD={{ host.booklore.db_password }} # Use a strong password; must match MYSQL_PASSWORD defined in the mariadb container 
      - SWAGGER_ENABLED=false # Enable or disable Swagger UI (API docs). Set to 'true' to allow access; 'false' to block access (recommended for production).
    depends_on:
      mariadb:
        condition: service_healthy
    ports:
      - "{{ booklore.ports.web }}:6060"
    volumes:
      - {{ booklore.volumes.data }}:/app/data
      - {{ booklore.volumes.books }}:/books
      - {{ booklore.volumes.bookdrop }}:/bookdrop
    restart: unless-stopped

  mariadb:
    image: lscr.io/linuxserver/mariadb:11.4.5
    container_name: booklore-mariadb
    environment:
      - PUID=1000
      - PGID=1001
      - TZ={{ docker.tz }}
      - MYSQL_ROOT_PASSWORD={{ host.booklore.root_password }} # Use a strong password for the database's root user, should be different from MYSQL_PASSWORD
      - MYSQL_DATABASE={{ host.booklore.db_name }}
      - MYSQL_USER={{ host.booklore.db_user }} # Must match DATABASE_USERNAME defined in the booklore container
      - MYSQL_PASSWORD={{ host.booklore.db_password }} # Use a strong password; must match DATABASE_PASSWORD defined in the booklore container
    volumes:
      - {{ booklore.volumes.config }}:/config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 10
  
  cwabd:
    image: ghcr.io/calibrain/calibre-web-automated-book-downloader:latest
    container_name: cwabd
    depends_on:
      mariadb:
        condition: service_healthy
    environment:
      FLASK_PORT: 8084
      LOG_LEVEL: info
      BOOK_LANGUAGE: fr,en
      USE_BOOK_TITLE: true
      TZ: {{ docker.tz }}
      APP_ENV: prod
      UID: 1000
      GID: 1001
    ports:
      - {{ cwabd.ports.downloader }}:8084
    restart: unless-stopped
    volumes:
    # This is where the books will be downloaded to, usually it would be 
    # the same as whatever you gave in "calibre-web-automated"
      - {{ booklore.volumes.bookdrop }}:/cwa-book-ingest

